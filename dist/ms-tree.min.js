function MSTreeManager(e){if(this.$place=null,this.msapi=null,this.display_root=!1,this.display_personal=!1,this.auto_init=!0,this.current_channel_oid="0",this.on_change=null,this.on_data_retrieved=null,this.on_tree_loaded=null,this.channels_base_url="/channels/#",this.channels_url_field="slug",this.tree_url="",this.path_url="",this.$widget=null,this.loaded=!1,this.loading=!1,this.content={0:{oid:"0",parent_oid:null}},this.loading_queue={},this.has_personal_channel=!1,this.personal_channel_info=null,jsu.setObjectAttributes(this,e,["$place","msapi","display_root","display_personal","auto_init","current_channel_oid","on_change","on_data_retrieved","on_tree_loaded","channels_base_url","channels_url_field","tree_url","path_url"]),this.initial_oid=this.current_channel_oid,this.msapi||(this.msapi=new MSAPIClient(e)),this.auto_init){var t=this;$(document).ready(function(){t.init()})}}MSTreeManager.prototype.init=function(){var e,t;if(!this.loaded&&!this.loading){if(!this.$place)return console.log("No place defined for tree.");if(!this.$place.length)return console.log("Place for tree doesn't exist. Requested place:",this.$place);for(this.loading=!0,window.location.search&&(this.channels_base_url=this.channels_base_url.substring(0,this.channels_base_url.length-1)+window.location.search+"#"),this.id_prefix="";$("#"+this.id_prefix+"tree_channel_0").length>0;)this.id_prefix+="_";e="<div>",this.display_root&&(e+='<div id="'+this.id_prefix+'tree_channel_0_link" '+("0"==this.current_channel_oid?'class="channel-active"':"")+">",this.on_change?e+='<button type="button" data-ref="0" class="channel-btn"'+("0"==this.current_channel_oid?'title="'+jsu.translate("Root")+" "+jsu.translate("selected")+'"':"")+">"+jsu.translate("Root")+"</button>":e+='<a href="'+this.channels_base_url+'" class="channel-btn"'+("0"==this.current_channel_oid?'title="'+jsu.translate("Root")+" "+jsu.translate("selected")+'"':"")+">"+jsu.translate("Root")+"</a>",e+="</div>"),e+='<ul class="list js-active-item border-color-blue active" id="'+this.id_prefix+'tree_channel_0"></ul></div>',this.$widget=$(e),this.display_root&&this.on_change&&$(".channel-btn",this.$widget).click({obj:this},function(e){e.data.obj.on_change($(this).attr("data-ref"))}),t=this,this.loading=!1,this.load_tree("0",function(e){if(t.loaded=!0,e.success&&t.initial_oid&&t.current_channel_oid==t.initial_oid&&t.open_tree(t.current_channel_oid),t.display_personal&&t.has_personal_channel){var n=$('<button type="button" class="button channel-personal-btn"><i class="fa fa-bookmark" aria-hidden="true"></i> <span>'+jsu.translate("My channel")+"</span></button>");n.click({obj:t},function(e){e.data.obj.open_personal_channel()}),t.$widget.prepend(n)}t.$place.empty(),t.$place.append(t.$widget),t.on_tree_loaded&&t.on_tree_loaded()})}},MSTreeManager.prototype.load_tree=function(e,t){var n,a,i,s,o;if(void 0!==e)if(this.content[e]&&this.content[e].loaded)t&&t({success:!0,oid:e});else if(this.loading)this.loading_queue[e]=t;else{if(this.loading=!0,this.content[e]||(this.content[e]={oid:e}),n={recursive:"no"},"0"!=e&&(n.parent_oid=e),a=this,!(i=$("#"+this.id_prefix+"tree_channel_"+e,this.$widget)).length)return this.loading=!1,void(t&&t({success:!0,oid:e}));this.content[e].timeout=setTimeout(function(){a.content[e].timeout=null,i.css("display","block"),i.html('<li style="display: block;"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i> '+jsu.translate("Loading")+"...</li>")},500),s=function(n){a._on_tree_loaded(n,e,i,t)},o=function(n,s,o){if(n.status){if(401==n.status)return a._on_tree_loaded({success:!1,error:jsu.translate("Unable to get channels tree because you are not logged in.")},e,i,t);if(403==n.status)return a._on_tree_loaded({success:!1,error:jsu.translate("Unable to get channels tree because you cannot access to this channel.")},e,i,t);if(404==n.status)return a._on_tree_loaded({success:!1,error:jsu.translate("Channel does not exist.")},e,i,t);if(500==n.status)return a._on_tree_loaded({success:!1,error:jsu.translate("An error occurred in the server. Please try again later.")},e,i,t)}"timeout"==s?a._on_tree_loaded({success:!1,error:jsu.translate("Unable to get channels tree. Request timed out.")},e,i,t):"error"==s?a._on_tree_loaded({success:!1,error:jsu.translate("The server cannot be reached.")},e,i,t):a._on_tree_loaded({success:!1,error:jsu.translate("An error occurred during request:")+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;"+s+" "+o},e,i,t)},this.tree_url?$.ajax({url:this.tree_url,data:n,dataType:"json",cache:!1,success:s,error:o}):this.msapi.ajax_call("get_channels_tree",n,function(e){e.success?s(e):o(e.xhr,e.textStatus,e.thrownError)})}},MSTreeManager.prototype._on_tree_loaded=function(e,t,n,a){var i,s,o,r,l,c,h;if(this.content[t].timeout&&(clearTimeout(this.content[t].timeout),delete this.content[t].timeout),e.success){if(e.channels){for(s="",o=0;o<e.channels.length;o++){if((r=e.channels[o]).parent_oid="0"!=t?t:"0",this.content[r.oid])for(l in r)this.content[r.oid][l]=r[l];else this.content[r.oid]=r;this.on_data_retrieved&&this.on_data_retrieved(r),c="",r.channels&&(c='<button type="button" aria-expanded="false" aria-controls="tree_channel_'+r.oid+'" aria-label="'+r.title+'" data-ref="'+r.oid+'" class="channel-toggle button-text list-entry"><i class="fa fa-fw fa-angle-right" aria-hidden="true"></i></button>'),s+='<li><span id="'+this.id_prefix+"tree_channel_"+r.oid+'_link" data-ref="'+r.oid+'" class="'+(this.on_change?"":"aside-list-btn")+(this.current_channel_oid==r.oid?" channel-active":"")+'">'+c,this.on_change?s+="<button "+(r.language?'lang="'+r.language+'"':"")+' type="button" data-ref="'+r.oid+'" class="channel-btn"'+(this.current_channel_oid==r.oid?' title="'+jsu.escapeHTML(r.title)+" "+jsu.translate("selected")+'"':"")+">"+jsu.escapeHTML(r.title)+"</button>":s+="<a "+(r.language?'lang="'+r.language+'"':"")+' href="'+this.channels_base_url+r[this.channels_url_field]+'" class="channel-btn">'+jsu.escapeHTML(r.title)+"</a>",s+="</span>",r.channels&&(s+='<ul class="list border-color-blue" id="'+this.id_prefix+"tree_channel_"+r.oid+'"></ul>'),s+="</li>",void 0!==this.loading_queue[r.oid]&&(i={oid:r.oid,cb:this.loading_queue[r.oid]},delete this.loading_queue[r.oid])}h=$(s),n.empty(),n.append(h),this.on_change&&$(".channel-btn",h).click({obj:this},function(e){e.data.obj.on_change($(this).attr("data-ref"))}),$(".channel-toggle",h).click({obj:this},function(e){e.stopPropagation(),e.data.obj.toggle_channel($(this).attr("data-ref"))}),$(".aside-list-btn",h).click({obj:this},function(e){e.stopPropagation(),e.data.obj.toggle_channel($(this).attr("data-ref"))})}this.content[t].loaded=!0,e.personal_channel&&(this.has_personal_channel=!0)}else e.error?n.html('<li class="error">'+e.error+"</li>"):n.html('<li class="error">'+jsu.translate("No information about error.")+"</li>");this.loading=!1,i&&this.load_tree(i.oid,i.cb),a&&(e.oid=t,a(e))},MSTreeManager.prototype.open_tree=function(e){var t,n;"0"!=e&&(t=this,n=function(){for(var n,a=[],i=t.content[e];i;)a.push(i.oid),i=t.content[i.parent_oid];for(a.reverse(),n=0;n<a.length;n++)"0"!=a[n]&&t.load_tree(a[n],function(e){$("#"+t.id_prefix+"tree_channel_"+e.oid,t.$widget).css("display","block").addClass("active"),$("#"+t.id_prefix+"tree_channel_"+e.oid+"_link .channel-toggle",t.$widget).addClass("fa-rotate-90"),$("#"+t.id_prefix+"tree_channel_"+e.oid+"_link .channel-toggle",t.$widget).attr("aria-expanded",!0)})},this.content[e]||(this.content[e]={oid:e}),void 0===this.content[e].parent_oid?this.load_path(e,function(a){var i,s,o,r=[];for(a.path&&a.path.length>0&&(r=a.path),r.push(t.content[e]),i=0;i<r.length;i++){if((s=r[i]).parent_oid=i>0?r[i-1].oid:"0",t.content[s.oid])for(o in s)t.content[s.oid][o]=s[o];else t.content[s.oid]=s;t.on_data_retrieved&&t.on_data_retrieved(s)}n()}):n())},MSTreeManager.prototype.close_tree=function(e){$("#"+this.id_prefix+"tree_channel_"+e,this.$widget).css("display","none").removeClass("active"),$("#"+this.id_prefix+"tree_channel_"+e+"_link .channel-toggle",this.$widget).attr("aria-expanded",!1),$("#"+this.id_prefix+"tree_channel_"+e+"_link .channel-toggle",this.$widget).removeClass("fa-rotate-90")},MSTreeManager.prototype.toggle_channel=function(e){$("#"+this.id_prefix+"tree_channel_"+e+"_link .channel-toggle",this.$widget).hasClass("fa-rotate-90")?this.close_tree(e):this.open_tree(e)},MSTreeManager.prototype.set_active=function(e){this.current_channel_oid!=e&&($(".channel-active button",this.$widget).removeAttr("title"),$(".channel-active",this.$widget).removeClass("channel-active"),this.current_channel_oid=e,$("#"+this.id_prefix+"tree_channel_"+this.current_channel_oid+"_link",this.$widget).addClass("channel-active"),$("#"+this.id_prefix+"tree_channel_"+this.current_channel_oid+"_link button",this.$widget).attr("title",$("#"+this.id_prefix+"tree_channel_"+this.current_channel_oid+"_link",this.$widget).text()+" "+jsu.translate("selected")),this.open_tree(e))},MSTreeManager.prototype.load_path=function(e,t){var n={oid:e},a=function(n){n.success||console.log("Error getting path for oid "+e+". Error: "+n.error),t(n)},i=function(n,a,i){console.log("Error getting path for oid "+e+". Error: "+a+" | "+i),t({success:!1,error:a+" | "+i})};this.path_url?$.ajax({url:this.path_url,data:n,dataType:"json",cache:!1,success:a,error:i}):this.msapi.ajax_call("get_channels_path",n,function(e){e.success?a(e):i(e.xhr,e.textStatus,e.thrownError)})},MSTreeManager.prototype.open_personal_channel=function(){var e=this,t=function(t){t.success?(e.personal_channel_info=t,$(".channel-personal-btn span",e.$widget).html(jsu.translate("My channel")),e.open_tree(t.oid),e.on_change?e.on_change(t.oid):window.location.hash="#"+t.slug):$(".channel-personal-btn span",e.$widget).html(jsu.translate("My channel")+" ("+t.xhr.status+")")};this.personal_channel_info?t(this.personal_channel_info):this.msapi.ajax_call("get_channels_personal",{},function(e){t(e)})};