function MSTreeManager(e){if(this.$place=null,this.msapi=null,this.displayRoot=!1,this.displayPersonal=!1,this.autoInit=!0,this.currentChannelOid="0",this.onChange=null,this.onDataRetrieved=null,this.onTreeLoaded=null,this.channelsBaseUrl="/channels/#",this.channelsUrlField="slug",this.treeUrl="",this.pathUrl="",this.$widget=null,this.loaded=!1,this.loading=!1,this.content={0:{oid:"0",parent_oid:null}},this.loadingQueue={},this.hasPersonalChannel=!1,this.personalChannelInfo=null,jsu.setObjectAttributes(this,e,["$place","msapi","displayRoot","displayPersonal","autoInit","currentChannelOid","onChange","onDataRetrieved","onTreeLoaded","channelsBaseUrl","channelsUrlField","treeUrl","pathUrl"]),this.initialOid=this.currentChannelOid,this.msapi||(this.msapi=new MSAPIClient(e)),this.autoInit){const e=this;$(document).ready(function(){e.init()})}}MSTreeManager.prototype.init=function(){if(this.loaded||this.loading)return;if(!this.$place)return console.log("No place defined for tree.");if(!this.$place.length)return console.log("Place for tree doesn't exist. Requested place:",this.$place);for(this.loading=!0,window.location.search&&(this.channelsBaseUrl=this.channelsBaseUrl.substring(0,this.channelsBaseUrl.length-1)+window.location.search+"#"),this.idPrefix="";$("#"+this.idPrefix+"tree_channel_0").length>0;)this.idPrefix+="_";let e="<div>";this.displayRoot&&(e+='<div id="'+this.idPrefix+'tree_channel_0_link" '+("0"==this.currentChannelOid?'class="channel-active"':"")+">",this.onChange?e+='<button type="button" data-ref="0" class="channel-btn"'+("0"==this.currentChannelOid?'title="'+jsu.translateAttribute("Root")+" "+jsu.translateAttribute("selected")+'"':"")+">"+jsu.translateHTML("Root")+"</button>":e+='<a href="'+this.channelsBaseUrl+'" class="channel-btn"'+("0"==this.currentChannelOid?'title="'+jsu.translateAttribute("Root")+" "+jsu.translateAttribute("selected")+'"':"")+">"+jsu.translateHTML("Root")+"</a>",e+="</div>"),e+='<ul class="list js-active-item border-color-blue active" id="'+this.idPrefix+'tree_channel_0"></ul></div>',this.$widget=$(e),this.displayRoot&&this.onChange&&$(".channel-btn",this.$widget).click({obj:this},function(e){e.data.obj.onChange($(this).attr("data-ref"))});const t=this;this.loading=!1,this.loadTree("0",function(e){if(t.loaded=!0,e.success&&t.initialOid&&t.currentChannelOid==t.initialOid&&t.openTree(t.currentChannelOid),t.displayPersonal&&t.hasPersonalChannel){const e=$('<button type="button" class="button channel-personal-btn"><i class="fa fa-bookmark" aria-hidden="true"></i> <span>'+jsu.translateHTML("My channel")+"</span></button>");e.click({obj:t},function(e){e.data.obj.openPersonalChannel()}),t.$widget.prepend(e)}t.$place.empty(),t.$place.append(t.$widget),t.onTreeLoaded&&t.onTreeLoaded()})},MSTreeManager.prototype.loadTree=function(e,t){if(void 0===e)return;if(this.content[e]&&this.content[e].loaded)return void(t&&t({success:!0,oid:e}));if(this.loading)return void(this.loadingQueue[e]=t);this.loading=!0,this.content[e]||(this.content[e]={oid:e});const n={recursive:"no"};"0"!=e&&(n.parent_oid=e);const a=this,i=$("#"+this.idPrefix+"tree_channel_"+e,this.$widget);if(!i.length)return this.loading=!1,void(t&&t({success:!0,oid:e}));this.content[e].timeout=setTimeout(function(){a.content[e].timeout=null,i.css("display","block"),i.html('<li style="display: block;"><i class="fa fa-spinner fa-spin" aria-hidden="true"></i> '+jsu.translateHTML("Loading")+"...</li>")},500);const s=function(n){a._onTreeLoaded(n,e,i,t)},o=function(n,s,o){if(n.status)switch(n.status){case 401:return a._onTreeLoaded({success:!1,error:jsu.translate("Unable to get channels tree because you are not logged in.")},e,i,t);case 403:return a._onTreeLoaded({success:!1,error:jsu.translate("Unable to get channels tree because you cannot access to this channel.")},e,i,t);case 404:return a._onTreeLoaded({success:!1,error:jsu.translate("Channel does not exist.")},e,i,t);case 500:return a._onTreeLoaded({success:!1,error:jsu.translate("An error occurred in the server. Please try again later.")},e,i,t)}"timeout"==s?a._onTreeLoaded({success:!1,error:jsu.translate("Unable to get channels tree. Request timed out.")},e,i,t):"error"==s?a._onTreeLoaded({success:!1,error:jsu.translate("The server cannot be reached.")},e,i,t):a._onTreeLoaded({success:!1,error:jsu.translate("An error occurred during request:")+"<br/>&nbsp;&nbsp;&nbsp;&nbsp;"+s+" "+o},e,i,t)};this.treeUrl?$.ajax({url:this.treeUrl,data:n,dataType:"json",cache:!1,success:s,error:o}):this.msapi.ajaxCall("getChannelsTree",n,function(e){e.success?s(e):o(e.xhr,e.textStatus,e.thrownError)})},MSTreeManager.prototype._onTreeLoaded=function(e,t,n,a){let i;if(this.content[t].timeout&&(clearTimeout(this.content[t].timeout),delete this.content[t].timeout),e.success){if(e.channels){let a="";for(let n=0;n<e.channels.length;n++){const s=e.channels[n];if(s.parent_oid="0"!=t?t:"0",this.content[s.oid]){let e;for(e in s)this.content[s.oid][e]=s[e]}else this.content[s.oid]=s;this.onDataRetrieved&&this.onDataRetrieved(s);let o="";s.channels&&(o='<button type="button" aria-expanded="false" aria-controls="tree_channel_'+s.oid+'" aria-label="'+jsu.escapeAttribute(s.title)+'" data-ref="'+s.oid+'" class="channel-toggle button-text list-entry"><i class="fa fa-fw fa-angle-right" aria-hidden="true"></i></button>'),a+='<li><span id="'+this.idPrefix+"tree_channel_"+s.oid+'_link" data-ref="'+s.oid+'" class="'+(this.onChange?"":"aside-list-btn")+(this.currentChannelOid==s.oid?" channel-active":"")+'">'+o,this.onChange?a+="<button "+(s.language?'lang="'+jsu.escapeAttribute(s.language)+'"':"")+' type="button" data-ref="'+s.oid+'" class="channel-btn"'+(this.currentChannelOid==s.oid?' title="'+jsu.escapeAttribute(s.title+" "+jsu.translate("selected"))+'"':"")+">"+jsu.escapeHTML(s.title)+"</button>":a+="<a "+(s.language?'lang="'+jsu.escapeAttribute(s.language)+'"':"")+' href="'+this.channelsBaseUrl+s[this.channelsUrlField]+'" class="channel-btn">'+jsu.escapeHTML(s.title)+"</a>",a+="</span>",s.channels&&(a+='<ul class="list border-color-blue" id="'+this.idPrefix+"tree_channel_"+s.oid+'"></ul>'),a+="</li>",void 0!==this.loadingQueue[s.oid]&&(i={oid:s.oid,cb:this.loadingQueue[s.oid]},delete this.loadingQueue[s.oid])}const s=$(a);n.empty(),n.append(s),this.onChange&&$(".channel-btn",s).click({obj:this},function(e){e.data.obj.onChange($(this).attr("data-ref"))}),$(".channel-toggle",s).click({obj:this},function(e){e.stopPropagation(),e.data.obj.toggleChannel($(this).attr("data-ref"))}),$(".aside-list-btn",s).click({obj:this},function(e){e.stopPropagation(),e.data.obj.toggleChannel($(this).attr("data-ref"))})}this.content[t].loaded=!0,e.personal_channel&&(this.hasPersonalChannel=!0)}else e.error?n.html('<li class="error">'+jsu.escapeHTML(e.error)+"</li>"):n.html('<li class="error">'+jsu.translateHTML("No information about error.")+"</li>");this.loading=!1,i&&this.loadTree(i.oid,i.cb),a&&(e.oid=t,a(e))},MSTreeManager.prototype.openTree=function(e){if("0"==e)return;const t=this,n=function(){const n=[];let a=t.content[e];for(;a;)n.push(a.oid),a=t.content[a.parent_oid];n.reverse();for(let e=0;e<n.length;e++)"0"!=n[e]&&t.loadTree(n[e],function(e){$("#"+t.idPrefix+"tree_channel_"+e.oid,t.$widget).css("display","block").addClass("active"),$("#"+t.idPrefix+"tree_channel_"+e.oid+"_link .channel-toggle",t.$widget).addClass("fa-rotate-90"),$("#"+t.idPrefix+"tree_channel_"+e.oid+"_link .channel-toggle",t.$widget).attr("aria-expanded",!0)})};this.content[e]||(this.content[e]={oid:e}),void 0===this.content[e].parent_oid?this.loadPath(e,function(a){let i=[];a.path&&a.path.length>0&&(i=a.path),i.push(t.content[e]);for(let e=0;e<i.length;e++){const n=i[e];if(n.parent_oid=e>0?i[e-1].oid:"0",t.content[n.oid]){let e;for(e in n)t.content[n.oid][e]=n[e]}else t.content[n.oid]=n;t.onDataRetrieved&&t.onDataRetrieved(n)}n()}):n()},MSTreeManager.prototype.closeTree=function(e){$("#"+this.idPrefix+"tree_channel_"+e,this.$widget).css("display","none").removeClass("active"),$("#"+this.idPrefix+"tree_channel_"+e+"_link .channel-toggle",this.$widget).attr("aria-expanded",!1),$("#"+this.idPrefix+"tree_channel_"+e+"_link .channel-toggle",this.$widget).removeClass("fa-rotate-90")},MSTreeManager.prototype.toggleChannel=function(e){$("#"+this.idPrefix+"tree_channel_"+e+"_link .channel-toggle",this.$widget).hasClass("fa-rotate-90")?this.closeTree(e):this.openTree(e)},MSTreeManager.prototype.setActive=function(e){this.currentChannelOid!=e&&($(".channel-active button",this.$widget).removeAttr("title"),$(".channel-active",this.$widget).removeClass("channel-active"),this.currentChannelOid=e,$("#"+this.idPrefix+"tree_channel_"+this.currentChannelOid+"_link",this.$widget).addClass("channel-active"),$("#"+this.idPrefix+"tree_channel_"+this.currentChannelOid+"_link button",this.$widget).attr("title",$("#"+this.idPrefix+"tree_channel_"+this.currentChannelOid+"_link",this.$widget).text()+" "+jsu.translate("selected")),this.openTree(e))},MSTreeManager.prototype.loadPath=function(e,t){const n={oid:e},a=function(n){n.success||console.log("Error getting path for oid "+e+". Error: "+n.error),t(n)},i=function(n,a,i){console.log("Error getting path for oid "+e+". Error: "+a+" | "+i),t({success:!1,error:a+" | "+i})};this.pathUrl?$.ajax({url:this.pathUrl,data:n,dataType:"json",cache:!1,success:a,error:i}):this.msapi.ajaxCall("getChannelsPath",n,function(e){e.success?a(e):i(e.xhr,e.textStatus,e.thrownError)})},MSTreeManager.prototype.openPersonalChannel=function(){const e=this,t=function(t){t.success?(e.personalChannelInfo=t,$(".channel-personal-btn span",e.$widget).text(jsu.translate("My channel")),e.openTree(t.oid),e.onChange?e.onChange(t.oid):window.location.hash="#"+t.slug):$(".channel-personal-btn span",e.$widget).text(jsu.translate("My channel")+" ("+t.xhr.status+")")};this.personalChannelInfo?t(this.personalChannelInfo):this.msapi.ajaxCall("getChannelsPersonal",{},function(e){t(e)})};